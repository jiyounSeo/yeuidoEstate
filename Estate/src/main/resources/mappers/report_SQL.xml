<?xml version="1.0" encoding= "UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
 
<mapper namespace="reportDAO">

    <insert id="insertReport" parameterType="java.util.HashMap" >
      <selectKey resultType="string" keyProperty="contractId" order="BEFORE">
        SELECT ifnull(MAX(CAST(contractId AS UNSIGNED)) + 1, 1) from contract
      </selectKey>
    <![CDATA[
        INSERT into contract
				(contractId
				, contTp1
				, contTp2
				, contSttSe
				, dueDt
				, contSe
				, addr
				, assignee
				, assigneeTel
				, grantor
				, grantorTel
				, contDt
				, contAmt
				, midContDt
				, midContAmt
				, remainDt
				, remainAmt
				, chkContent
				, releaRsn
				, preFees
				, realFees
				, chngRsn
				, manager
				, boss
				, regDt
				, regUser
				  )
        	values ( 
        			#{contractId}
        		  	, #{contTpSelect1}
        		  	, #{contTpSelect2}
				, 1
				, CASE WHEN #{dueDt} = '' THEN NULL ELSE #{dueDt} END
				, #{contSe}
				, CASE WHEN #{addr} = '' THEN NULL ELSE #{addr} END
				, #{assignee}
				, #{assigneeTel}
				, #{grantor}
				, #{grantorTel}
				, CASE WHEN #{contDt} = '' THEN NULL ELSE #{contDt} END
				, CASE WHEN #{contAmt} = '' THEN NULL ELSE #{contAmt} END
				, CASE WHEN #{midContDt} = '' THEN NULL ELSE #{midContDt} END
				, CASE WHEN #{midContAmt} = '' THEN NULL ELSE #{midContAmt} END
				, CASE WHEN #{remainDt} = '' THEN NULL ELSE #{remainDt} END
				, CASE WHEN #{remainAmt} = '' THEN NULL ELSE #{remainAmt} END
				, CASE WHEN #{chkContent} = '' THEN NULL ELSE #{chkContent} END
				, CASE WHEN #{releaRsn} = '' THEN NULL ELSE #{releaRsn} END
				, CASE WHEN #{preFees} = '' THEN NULL ELSE #{preFees} END
				, CASE WHEN #{realFees} = '' THEN NULL ELSE #{realFees} END
				, CASE WHEN #{chngRsn} = '' THEN NULL ELSE #{chngRsn} END
				, #{manager}
				, #{bossSelect}
				, now()
				, #{user.loginId}
		      	);
       ]]>
    </insert>

    <update  id="modifyReport" parameterType="java.util.HashMap" >
     UPDATE contract
       SET
		contTp1 = #{contTpSelect1}
		, contTp2 = #{contTpSelect2}
		, contSttSe = #{contSttSe}
		, dueDt = CASE WHEN #{dueDt} = '' THEN NULL ELSE #{dueDt} END
		, contSe = #{contSe}
		, addr = CASE WHEN #{addr} = '' THEN NULL ELSE #{addr} END
		, assignee = #{assignee}
		, assigneeTel = #{assigneeTel}
		, grantor = #{grantor}
		, grantorTel = #{grantorTel}
		, contDt = CASE WHEN #{contDt} = '' THEN NULL ELSE #{contDt} END
		, contAmt = CASE WHEN #{contAmt} = '' THEN NULL ELSE #{contAmt} END
		, midContDt = CASE WHEN #{midContDt} = '' THEN NULL ELSE #{midContDt} END
		, midContAmt = CASE WHEN #{midContAmt} = '' THEN NULL ELSE #{midContAmt} END
		, remainDt = CASE WHEN #{remainDt} = '' THEN NULL ELSE #{remainDt} END
		, remainAmt = CASE WHEN #{remainAmt} = '' THEN NULL ELSE #{remainAmt} END
		, chkContent = CASE WHEN #{chkContent} = '' THEN NULL ELSE #{chkContent} END
		, releaRsn = CASE WHEN #{releaRsn} = '' THEN NULL ELSE #{releaRsn} END
		, preFees = CASE WHEN #{preFees} = '' THEN NULL ELSE #{preFees} END
		, realFees = CASE WHEN #{realFees} = '' THEN NULL ELSE #{realFees} END
		, chngRsn = #{chngRsn}
		, manager = #{manager}
		, boss = #{bossSelect}
		, regDt = now()
     WHERE contractId = #{contractId}
    </update>

    <delete id="deleteReport" parameterType="java.util.HashMap" >
    DELETE FROM contract 
    WHERE contractId = #{contractId}
    </delete>
    
	<select id="selectReportList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	SELECT contractId
		, contTp1
		, contTp2
		, contSttSe
		, DATE_FORMAT(dueDt, '%Y-%m-%d') as dueDt
		, contSe
		, addr
		, assignee
		, assigneeTel
		, grantor
		, grantorTel
		, DATE_FORMAT(contDt, '%Y-%m-%d') as contDt
		, contAmt
		, DATE_FORMAT(midContDt, '%Y-%m-%d') as midContDt
		, midContAmt
		, DATE_FORMAT(remainDt, '%Y-%m-%d') as remainDt
		, remainAmt
		, chkContent
		, releaRsn
		, preFees
		, realFees
		, chngRsn
		, manager
		, boss
		, regUser
		, (SELECT COUNT(*) FROM estate.contract) totalCnt
	  FROM estate.contract
	  where regUser = #{user.loginId}
	   LIMIT #{rowNum}, #{pagePerRow}
	</select>
	
	<select id="selectBossList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	SELECT mbrId
		,mbrNm
		FROM estate.member
		where (estate.member.mbrTp='MT003' AND estate.member.estateCd = ${user.estateCd} ) OR estate.member.mbrTp='MT004'
	</select>
	
	<select id="selectReportInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	SELECT contractId
		, contTp1
		, contTp2
		, contSttSe
		, DATE_FORMAT(dueDt, '%Y-%m-%d') as dueDt
		, contSe
		, addr
		, assignee
		, assigneeTel
		, grantor
		, grantorTel
		, DATE_FORMAT(contDt, '%Y-%m-%d') as contDt
		, contAmt
		, DATE_FORMAT(midContDt, '%Y-%m-%d') as midContDt
		, midContAmt
		, DATE_FORMAT(remainDt, '%Y-%m-%d') as remainDt
		, remainAmt
		, chkContent
		, releaRsn
		, preFees
		, realFees
		, chngRsn
		, manager
		, boss
		, DATE_FORMAT(regDt, '%Y-%m-%d') as regDt
		, regUser
	  FROM estate.contract
	 WHERE contractId = #{contractId}
	</select>
	
	
</mapper>